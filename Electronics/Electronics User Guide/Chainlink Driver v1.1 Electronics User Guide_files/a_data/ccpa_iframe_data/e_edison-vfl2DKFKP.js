define(["require","exports","./c_tslib","react","react-dom","./c_apex-metrics_src_types"],(function(e,t,r,n,s,i){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}var a=o(n),d=o(s);const c={DEBUG:!1,IDLE_TIMEOUT:200,NETWORK_TIMEOUT:6e4};class l{static format(...e){return["[ttvc]",...e,"::",performance.now()]}static debug(...e){c.DEBUG&&console.debug(...this.format(...e))}static info(...e){c.DEBUG&&console.info(...this.format(...e))}static warn(...e){c.DEBUG&&console.warn(...this.format(...e))}}class u{constructor(){this.pendingRequests=0,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{l.debug("AjaxIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{if(0===c.NETWORK_TIMEOUT)return;this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{l.warn("AjaxIdleObservable","::","Timed out waiting for requests to resolve.","Make sure that incrementAjaxCount() is always matched with decrementAjaxCount().","::","pendingRequests =",this.pendingRequests),this.didNetworkTimeOut=!0,this.pendingRequests=0,this.next("IDLE")}),c.NETWORK_TIMEOUT)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.increment=()=>{this.startCleanupTimeout(),0===this.pendingRequests&&this.next("BUSY"),this.pendingRequests+=1},this.decrement=()=>{this.abortCleanupTimeout(),1===this.pendingRequests?this.next("IDLE"):this.startCleanupTimeout(),this.pendingRequests=Math.max(this.pendingRequests-1,0),this.pendingRequests<10&&l.debug("AjaxIdleObservable.decrement()","::","pendingRequests =",this.pendingRequests)},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}}}}class m{constructor(){this.pendingResources=new Set,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{l.debug("ResourceLoadingIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{if(0===c.NETWORK_TIMEOUT)return;this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{l.warn("ResourceLoadingIdleObservable","::","Timed out waiting for resources to resolve.","Consider filing a bug report if this continues to occur.","::","pendingResources =",this.pendingResources),this.didNetworkTimeOut=!0,this.pendingResources=new Set,this.next("IDLE")}),c.NETWORK_TIMEOUT)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.add=e=>{e instanceof HTMLImageElement&&!e.src||e instanceof HTMLImageElement&&e.complete||e instanceof HTMLLinkElement&&!e.href||e instanceof HTMLScriptElement&&!e.src||e instanceof HTMLIFrameElement&&!e.src||(this.startCleanupTimeout(),0===this.pendingResources.size&&this.next("BUSY"),this.pendingResources.add(e))},this.remove=e=>{this.abortCleanupTimeout(),this.pendingResources.delete(e),0===this.pendingResources.size?this.next("IDLE"):this.startCleanupTimeout(),this.pendingResources.size<10&&l.debug("ResourceLoadingIdleObservable.remove()","::","pendingResources =",this.pendingResources)},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},"undefined"!=typeof window&&(null===window||void 0===window?void 0:window.MutationObserver)&&window.addEventListener("load",(()=>{new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e instanceof HTMLScriptElement||e instanceof HTMLLinkElement||e instanceof HTMLImageElement||e instanceof HTMLIFrameElement?this.add(e):e.hasChildNodes()&&e instanceof HTMLElement&&e.querySelectorAll("img").forEach(this.add)}))}))})).observe(window.document.documentElement,{childList:!0,subtree:!0}),["load","error"].forEach((e=>{window.document.addEventListener(e,(e=>{(e.target instanceof HTMLScriptElement||e.target instanceof HTMLLinkElement||e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&this.remove(e.target)}),{capture:!0})}))}))}}class h{constructor(){this.ajaxIdleObservable=new u,this.resourceLoadingIdleObservable=new m,this.subscribers=new Set,this.ajaxIdle=!0,this.scriptLoadingIdle=!0,this.handleUpdate=e=>t=>{const r=this.ajaxIdle&&this.scriptLoadingIdle;"AJAX"===e&&(this.ajaxIdle="IDLE"===t),"RESOURCE_LOADING"===e&&(this.scriptLoadingIdle="IDLE"===t);const n=this.ajaxIdle&&this.scriptLoadingIdle;r!==n&&this.next(n?"IDLE":"BUSY")},this.next=e=>{l.debug("NetworkIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.incrementAjaxCount=()=>this.ajaxIdleObservable.increment(),this.decrementAjaxCount=()=>this.ajaxIdleObservable.decrement(),this.isIdle=()=>this.ajaxIdle&&this.scriptLoadingIdle,this.didNetworkTimeOut=()=>this.ajaxIdleObservable.didNetworkTimeOut||this.resourceLoadingIdleObservable.didNetworkTimeOut,this.resetDidNetworkTimeOut=()=>{this.ajaxIdleObservable.didNetworkTimeOut=!1,this.resourceLoadingIdleObservable.didNetworkTimeOut=!1},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},this.ajaxIdleObservable.subscribe(this.handleUpdate("AJAX")),this.resourceLoadingIdleObservable.subscribe(this.handleUpdate("RESOURCE_LOADING"))}}let g;const p=()=>(g||(g=new h),g);class f{constructor(e){this.mutationObserverConfig={attributeFilter:["hidden","style","src"],attributeOldValue:!0,attributes:!0,childList:!0,subtree:!0},this.mutations=new Map,this.mutationObserverCallback=e=>{l.debug("InViewportMutationObserver.mutationObserverCallback()","::","mutations =",e),e.forEach((e=>{e.timestamp=performance.now();let t=null;if(e.target instanceof Element&&(t=e.target),e.target instanceof Text&&(t=e.target.parentElement),t)if("childList"===e.type)e.addedNodes.forEach((t=>{t instanceof HTMLElement&&(this.intersectionObserver.observe(t),this.mutations.set(t,e)),t instanceof Text&&null!=t.parentElement&&(this.intersectionObserver.observe(t.parentElement),this.mutations.set(t.parentElement,e))}));else this.intersectionObserver.observe(t),this.mutations.set(t,e)}))},this.intersectionObserverCallback=e=>{l.debug("InViewportMutationObserver.intersectionObserverCallback()","::","entries =",e),e.forEach((e=>{const t=this.mutations.get(e.target);e.isIntersecting&&null!=t&&(l.info("InViewportMutationObserver.callback()","::","mutation =",t),this.callback(t)),this.mutations.delete(e.target),this.intersectionObserver.unobserve(e.target)}))},this.callback=e,this.mutationObserver=new MutationObserver(this.mutationObserverCallback),this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(e){l.info("InViewportMutationObserver.observe()","::","target =",e),this.mutationObserver.observe(e,this.mutationObserverConfig)}disconnect(){l.info("InViewportMutationObserver.disconnect()"),this.mutationObserver.disconnect(),this.intersectionObserver.disconnect()}}function w(e){const t=p();let r,n=t.isIdle();const s=e=>{n="IDLE"===e,n?(e=>{var t;(null!==(t=window.requestIdleCallback)&&void 0!==t?t:window.setTimeout)((()=>{window.requestAnimationFrame((()=>window.requestAnimationFrame(e)))}))})(i):(window.clearTimeout(r),r=void 0)},i=()=>{l.debug("requestAllIdleCallback.handleCpuIdle()"),n&&!r&&o()},o=()=>{r=window.setTimeout((()=>{const r=t.didNetworkTimeOut();t.resetDidNetworkTimeOut(),l.info("requestAllIdleCallback: ALL IDLE"),e(r),a()}),c.IDLE_TIMEOUT)},a=t.subscribe(s);n&&s("IDLE")}class v{constructor(e){this.imageLoadTimes=new Map,this.lastImageLoadTimestamp=0,this.intersectionObserverCallback=e=>{e.forEach((e=>{const t=e.target,r=this.imageLoadTimes.get(t);e.isIntersecting&&null!=r&&(l.info("InViewportImageObserver.callback()","::","timestamp =",r),this.callback(r,t)),this.intersectionObserver.unobserve(t),this.imageLoadTimes.delete(t)}))},this.handleLoadOrErrorEvent=e=>{(e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&(l.debug("InViewportImageObserver.handleLoadOrErrorEvent()","::","event =",e),this.imageLoadTimes.set(e.target,e.timeStamp),this.intersectionObserver.observe(e.target))},this.callback=e,this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(){l.info("InViewportImageObserver.observe()"),document.addEventListener("load",this.handleLoadOrErrorEvent,{capture:!0}),document.addEventListener("error",this.handleLoadOrErrorEvent,{capture:!0})}disconnect(){l.info("InViewportImageObserver.disconnect()"),this.lastImageLoadTimestamp=0,this.imageLoadTimes.clear(),this.intersectionObserver.disconnect(),document.removeEventListener("load",this.handleLoadOrErrorEvent),document.removeEventListener("error",this.handleLoadOrErrorEvent)}}const E=()=>{var e;return(null===(e=window.performance.getEntriesByType("navigation")[0])||void 0===e?void 0:e.type)||(()=>{const e=window.performance.navigation.type;return 2===e?"back_forward":1===e?"reload":"navigate"})()},b=()=>{var e;return(null===(e=window.performance.getEntriesByType("navigation")[0])||void 0===e?void 0:e.activationStart)||0};class P{constructor(){if(this.debug=!1,this.idleTimeout=200,this.lastImageLoadTimestamp=-1,this.navigationCount=0,this.successSubscribers=new Set,this.errorSubscribers=new Set,this.onTTVC=(e,t)=>(this.successSubscribers.add(e),t&&this.errorSubscribers.add(t),()=>{this.successSubscribers.delete(e),t&&this.errorSubscribers.delete(t)}),!P.isSupportedEnvironment())throw new Error("VisuallyCompleteCalculator: This browser/runtime is not supported.");this.inViewportMutationObserver=new f((e=>{var t,r,n;(null!==(t=e.timestamp)&&void 0!==t?t:0)>=(null!==(n=null===(r=this.lastMutation)||void 0===r?void 0:r.timestamp)&&void 0!==n?n:0)&&(this.lastMutation=e)})),this.inViewportImageObserver=new v(((e,t)=>{e>=this.lastImageLoadTimestamp&&(this.lastImageLoadTimestamp=e,this.lastImageLoadTarget=t)}))}static isSupportedEnvironment(){var e;return void 0!==window&&"MutationObserver"in window&&"IntersectionObserver"in window&&"function"==typeof document.querySelectorAll&&(null===(e=window.performance)||void 0===e?void 0:e.timing)}cancel(e){l.info("VisuallyCompleteCalculator.cancel()","::","index =",this.activeMeasurementIndex),this.activeMeasurementIndex&&this.error({start:b(),end:performance.now(),cancellationReason:"MANUAL_CANCELLATION",eventType:e,navigationType:E(),lastVisibleChange:this.getLastVisibleChange()}),this.activeMeasurementIndex=void 0}async start(e=0,t=!1){var r,n;const s=this.navigationCount+=1;this.activeMeasurementIndex=s,l.info("VisuallyCompleteCalculator.start()","::","index =",s);let i=t?"back_forward":e>0?"script":E();const o=b();o>e&&(e=o,i="prerender");const a=(t,r)=>{this.activeMeasurementIndex===s&&(this.activeMeasurementIndex=void 0,this.error({start:e,end:performance.now(),cancellationReason:r,eventType:t.type,eventTarget:t.target||void 0,navigationType:i,lastVisibleChange:this.getLastVisibleChange()}))},d=e=>a(e,"USER_INTERACTION"),c=e=>a(e,"NEW_NAVIGATION"),u=e=>a(e,"VISIBILITY_CHANGE");this.inViewportImageObserver.observe(),this.inViewportMutationObserver.observe(document.documentElement),window.addEventListener("pagehide",c),window.addEventListener("visibilitychange",u),window.setTimeout((()=>{window.addEventListener("click",d),window.addEventListener("keydown",d)}),0),await("complete"===document.readyState?Promise.resolve():new Promise((e=>{const t=()=>{e(),window.removeEventListener("load",t)};window.addEventListener("load",t)})));const m=await new Promise(w);if(s===this.activeMeasurementIndex){const t=Math.max(e,this.lastImageLoadTimestamp,null!==(n=null===(r=this.lastMutation)||void 0===r?void 0:r.timestamp)&&void 0!==n?n:0);this.next({start:e,end:t,duration:t-e,detail:{navigationType:i,didNetworkTimeOut:m,lastVisibleChange:this.getLastVisibleChange()}})}else l.debug("VisuallyCompleteCalculator: Measurement discarded","::","index =",s),this.activeMeasurementIndex&&this.error({start:e,end:performance.now(),cancellationReason:"NEW_NAVIGATION",navigationType:i,lastVisibleChange:this.getLastVisibleChange()});window.removeEventListener("pagehide",c),window.removeEventListener("visibilitychange",u),window.removeEventListener("click",d),window.removeEventListener("keydown",d),s===this.navigationCount&&(this.inViewportImageObserver.disconnect(),this.inViewportMutationObserver.disconnect())}next(e){var t,r;e.end>Number.MAX_SAFE_INTEGER?l.warn("VisuallyCompleteCalculator.next()","::","This browser reported a time larger than MAX_SAFE_INTEGER. We are ignoring it.","::",e):(l.debug("VisuallyCompleteCalculator.next()","::","lastImageLoadTimestamp =",this.lastImageLoadTimestamp,"lastMutationTimestamp =",null!==(r=null===(t=this.lastMutation)||void 0===t?void 0:t.timestamp)&&void 0!==r?r:0,"::","index =",this.activeMeasurementIndex),l.info("TTVC:",e,"::","index =",this.activeMeasurementIndex),this.successSubscribers.forEach((t=>t(e))))}error(e){l.debug("VisuallyCompleteCalculator.error()","::","cancellationReason =",e.cancellationReason,"::","eventType =",e.eventType||"none","::","index =",this.activeMeasurementIndex),this.errorSubscribers.forEach((t=>t(e)))}getLastVisibleChange(){var e,t;return this.lastImageLoadTimestamp>(null!==(t=null===(e=this.lastMutation)||void 0===e?void 0:e.timestamp)&&void 0!==t?t:0)?this.lastImageLoadTarget:this.lastMutation}}let y;let T;const _=p().incrementAjaxCount,S=p().decrementAjaxCount,R=["edison:preloadCss","js:requireCssWithComponent","js:require_css","loadCssWithCache","ensemble","css-modules"],I=["css-modules"];function C(e,t,r){if(r[t].length>0){if(I.includes(t)){const n=r[t];for(let t=0;t<n.length;t++){const{elem:r,path:s}=n[t];if(s>e.path)return[r,t]}}return[r[t][r[t].length-1].elem.nextElementSibling,null]}const n=R.indexOf(t);for(let e=n-1;e>=0;e--){const t=r[R[e]];if(t.length>0)return[t[t.length-1].elem.nextElementSibling,null]}for(let e=n+1;e<R.length;e++){const t=r[R[e]];if(t.length>0)return[t[0].elem,null]}return[null,null]}function M(e,t,r,n,s){e.elem.setAttribute("data-loader",t),e.elem instanceof HTMLStyleElement&&e.elem.setAttribute("path",e.path);let i=null,o=null;s||([i,o]=C(e,t,r)),null===o?r[t].push(e):r[t].splice(o,0,e),i?n.insertBefore(e.elem,i):n.appendChild(e.elem)}function O(e,t,r=document){const n=r.defaultView;n.__injectCssCache||(n.__injectCssCache={"edison:preloadCss":[],"js:require_css":[],"js:requireCssWithComponent":[],loadCssWithCache:[],ensemble:[],"css-modules":[]});const s=n.__injectCssCache,i=I.includes(t);if(!i&&e.length>1){const[n]=C(e[0],t,s),o=r.createDocumentFragment();for(const r of e)M(r,t,s,o,!i);null===n?r.head.appendChild(o):r.head.insertBefore(o,n)}else for(const n of e)M(n,t,s,r.head,!1)}function L(e){try{const t=new URL(e);return t.pathname?decodeURIComponent(t.pathname):""}catch(e){return""}}function A(e=document){const t=x(e),r=e.querySelectorAll('link[rel="stylesheet"]');for(let e=0;e<r.length;e++){let n=L(r[e].href);0,null==t.already_loaded_css_paths[n]&&(t.loaded_css[n]=Promise.resolve(),t.already_loaded_css_paths[n]="loaded")}}function x(e){const t=e;return t._cssCache||(t._cssCache={loaded_css:Object.create(null),already_loaded_css_paths:Object.create(null)}),t._cssCache}function N(e,t,r,n,s){let i=t.loaded_css[r];return i||(i=new Promise(((i,o)=>{const a=e.createElement("link");return a.href=n,a.rel="stylesheet",a.type="text/css",a.crossorigin="anonymous",a.onload=function(){return t.already_loaded_css_paths[r]="loaded",i()},a.onerror=o,O([{elem:a,path:r}],s,e),a})),t.loaded_css[r]=i,t.already_loaded_css_paths[r]="downloading"),i}var D,k;function q(){const e=window.performance?window.performance.now():0;return Math.floor(e)}A(),function(e){e.JsExecutionStart="js_execution_start",e.RequireLoadCallbackTime="require_load_callback_time",e.InitPageModuleLoadTime="init_page_module_load_time",e.PreloadModulesLoadTime="preload_modules_load_time",e.InitReceived="init_received",e.RenderStarted="render_started",e.RenderComplete="render_complete",e.FirstDataModuleReceived="first_data_module_received",e.LastDataModuleReceived="last_data_module_received",e.FirstCssPreloadReceived="first_css_preload_received",e.LastCssPreloadReceived="last_css_preload_received",e.ServerSidePrefetchStartedReceived="server_side_prefetch_started_received",e.DoneStreamingReceived="done_streaming_received",e.StreamedPrefetchWaitTime="streamed_prefetch_wait_time"}(D||(D={}));class j{constructor(e){this.AMP_NAMESPACE="web_timing";const{pageName:t,performanceNow:r=q,getLazyMetricsReporter:n}=e;this.pageName=t,this.performanceNow=r,this.lazyMetricsReporter=n?n():null,this.renderCompletePromise=new Promise((e=>{this.renderCompleteResolveFn=e})),this.eventTimings={},this.streamedPrefetchRequestTimingQueues={},this.streamedPrefetchResponseTimings={}}recordEventTime(e){this.eventTimings[e]=this.performanceNow()}recordEventTimeOnce(e){this.eventTimings[e]||this.recordEventTime(e)}getTags(e){return Object.assign({edison_page_name:this.pageName},e)}recordInitReceived(){this.recordEventTimeOnce(D.InitReceived)}recordRenderStarted(){this.recordEventTimeOnce(D.RenderStarted)}recordRenderComplete(){this.recordEventTimeOnce(D.RenderComplete),this.renderCompleteResolveFn()}recordDataModuleReceived(){this.recordEventTimeOnce(D.FirstDataModuleReceived),this.recordEventTime(D.LastDataModuleReceived)}recordCssPreloadReceived(){this.recordEventTimeOnce(D.FirstCssPreloadReceived),this.recordEventTime(D.LastCssPreloadReceived)}recordServerSidePrefetchStartedReceived(){this.recordEventTimeOnce(D.ServerSidePrefetchStartedReceived)}recordDoneStreamingReceived(){this.recordEventTimeOnce(D.DoneStreamingReceived)}saveEventTimings(){return r.__awaiter(this,void 0,void 0,(function*(){if(!this.lazyMetricsReporter)return;yield this.renderCompletePromise;const e=yield this.lazyMetricsReporter,t=Object.assign(Object.assign({},function(){const e={};return"number"==typeof window.EDISON_METRICS_JS_EXECUTION_START&&(e[D.JsExecutionStart]=window.EDISON_METRICS_JS_EXECUTION_START),"number"==typeof window.EDISON_METRICS_REQUIRE_LOAD_CALLBACK_TIME&&(e[D.RequireLoadCallbackTime]=window.EDISON_METRICS_REQUIRE_LOAD_CALLBACK_TIME),"number"==typeof window.EDISON_METRICS_INIT_PAGE_MODULE_LOAD_TIME&&(e[D.InitPageModuleLoadTime]=window.EDISON_METRICS_INIT_PAGE_MODULE_LOAD_TIME),"number"==typeof window.EDISON_METRICS_PRELOAD_MODULES_LOAD_TIME&&(e[D.PreloadModulesLoadTime]=window.EDISON_METRICS_PRELOAD_MODULES_LOAD_TIME),e}()),this.eventTimings);for(const[r,n]of Object.entries(t)){const t=this.getTags();e.createStats({ns:this.AMP_NAMESPACE,name:`edison/${r}`},t).recordDuration(n,i.TimeUnit.MILLISECONDS)}}))}recordStreamedPrefetchRequestTime(e,t){return r.__awaiter(this,void 0,void 0,(function*(){this.streamedPrefetchRequestTimingQueues[e]||(this.streamedPrefetchRequestTimingQueues[e]=[]),this.streamedPrefetchRequestTimingQueues[e].push({loggingIdentifier:t,requestTime:this.performanceNow(),processed:!1}),yield this.flushPrefetchTimingRecordQueue()}))}recordStreamedPrefetchResponseTime(e,t){return r.__awaiter(this,void 0,void 0,(function*(){this.streamedPrefetchResponseTimings[e]||(this.streamedPrefetchResponseTimings[e]={responseTime:this.performanceNow(),failed:t},yield this.flushPrefetchTimingRecordQueue())}))}flushPrefetchTimingRecordQueue(){return r.__awaiter(this,void 0,void 0,(function*(){if(!this.lazyMetricsReporter)return;const e=yield this.lazyMetricsReporter,t={};for(const[r,n]of Object.entries(this.streamedPrefetchRequestTimingQueues)){const s=this.streamedPrefetchResponseTimings[r];if(s)for(const r of n){const{loggingIdentifier:n,requestTime:o}=r,{responseTime:a,failed:d}=s;if(t[n]||(t[n]=0),t[n]++,r.processed)continue;const c=`${n}_${t[n]}`,l=this.getTags({prefetch_id:c,failed:`${d}`}),u=e.createStats({ns:this.AMP_NAMESPACE,name:`edison/${D.StreamedPrefetchWaitTime}`},l),m=Math.max(a-o,0);u.recordDuration(m,i.TimeUnit.MILLISECONDS),r.processed=!0}}}))}}function U(e,t){const r=i.protoBase64.dec(e);try{const e=i.Any.fromBinary(r);if(e&&e.typeUrl&&e.typeUrl.startsWith("type.googleapis.com/")&&e.value)return t.fromBinary(e.value)}catch(e){}try{return t.fromBinary(r)}catch(e){throw new Error(`Invalid data while trying to unpack encoded proto: ${e}`)}}function F(e){return i.protoBase64.enc(e.toBinary())}class B extends i.Message{constructor(e){super(),this.originalUrl="",this.currentUrl="",i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new B).fromBinary(e,t)}static fromJson(e,t){return(new B).fromJson(e,t)}static fromJsonString(e,t){return(new B).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(B,e,t)}}B.runtime=i.proto3,B.typeName="edison.prefetch.PrefetchArgs",B.fields=i.proto3.util.newFieldList((()=>[{no:10,name:"original_url",kind:"scalar",T:9},{no:11,name:"current_url",kind:"scalar",T:9}]));class J extends i.Message{constructor(e){super(),this.isFromOfficeIp=!1,i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new J).fromBinary(e,t)}static fromJson(e,t){return(new J).fromJson(e,t)}static fromJsonString(e,t){return(new J).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(J,e,t)}}J.runtime=i.proto3,J.typeName="edison_dws2.PrefetchArguments",J.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"is_from_office_ip",kind:"scalar",T:8},{no:2,name:"proto_arguments",kind:"message",T:i.Any}]));class V extends i.Message{constructor(e){super(),this.rpcProxyUrl="",this.atlasservlet="",this.pageName="",this.pageLifecycle="",this.activeUserId=i.protoInt64.zero,this.activeTeamId=i.protoInt64.zero,this.authRole=0,this.authActionType=0,this.uriPath="",this.legacyController="",this.legacyAction="",this.isOfficeIp=!1,this.staticRepoRev="",this.dws2RepoRev="",this.streamingEnabled=!1,this.isBuildTimePrefetchesEnabled=!1,this.entryPointModuleName="",this.beforeRenderModuleName="",this.isDws2Stage=!1,this.originalUrl="",this.originalReferer="",this.prefetchVersion=0,this.isProd=!1,this.gates={},i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new V).fromBinary(e,t)}static fromJson(e,t){return(new V).fromJson(e,t)}static fromJsonString(e,t){return(new V).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(V,e,t)}}V.runtime=i.proto3,V.typeName="edison_dws2.EdisonInitParams",V.fields=i.proto3.util.newFieldList((()=>[{no:22,name:"rpc_proxy_url",kind:"scalar",T:9},{no:2,name:"atlasservlet",kind:"scalar",T:9},{no:3,name:"page_name",kind:"scalar",T:9},{no:15,name:"page_lifecycle",kind:"scalar",T:9},{no:4,name:"active_user_id",kind:"scalar",T:4},{no:5,name:"active_team_id",kind:"scalar",T:4},{no:31,name:"auth_role",kind:"scalar",T:13},{no:32,name:"auth_action_type",kind:"scalar",T:13},{no:6,name:"uri_path",kind:"scalar",T:9},{no:9,name:"legacy_controller",kind:"scalar",T:9},{no:10,name:"legacy_action",kind:"scalar",T:9},{no:11,name:"is_office_ip",kind:"scalar",T:8},{no:12,name:"static_repo_rev",kind:"scalar",T:9},{no:13,name:"dws2_repo_rev",kind:"scalar",T:9},{no:14,name:"streaming_enabled",kind:"scalar",T:8},{no:30,name:"is_build_time_prefetches_enabled",kind:"scalar",T:8},{no:25,name:"entry_point_module_name",kind:"scalar",T:9},{no:26,name:"before_render_module_name",kind:"scalar",T:9},{no:27,name:"is_dws2_stage",kind:"scalar",T:8},{no:28,name:"original_url",kind:"scalar",T:9},{no:29,name:"original_referer",kind:"scalar",T:9},{no:33,name:"prefetchVersion",kind:"scalar",T:5},{no:34,name:"is_prod",kind:"scalar",T:8},{no:35,name:"gates",kind:"map",K:9,V:{kind:"scalar",T:8}}]));class H extends i.Message{constructor(e){super(),this.type={case:void 0},this.b64RequestKey="",i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new H).fromBinary(e,t)}static fromJson(e,t){return(new H).fromJson(e,t)}static fromJsonString(e,t){return(new H).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(H,e,t)}}H.runtime=i.proto3,H.typeName="edison_dws2.EdisonRequest",H.fields=i.proto3.util.newFieldList((()=>[{no:2,name:"service_method_prefetch",kind:"message",T:W,oneof:"type"},{no:3,name:"css_preload",kind:"message",T:z,oneof:"type"},{no:5,name:"module_preload",kind:"message",T:$,oneof:"type"},{no:4,name:"b64_request_key",kind:"scalar",T:9}]));class W extends i.Message{constructor(e){super(),this.service="",this.method="",this.initialPageAtlasservlet="",this.initialPageName="",i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new W).fromBinary(e,t)}static fromJson(e,t){return(new W).fromJson(e,t)}static fromJsonString(e,t){return(new W).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(W,e,t)}}W.runtime=i.proto3,W.typeName="edison_dws2.EdisonRequest.ServiceMethodPrefetch",W.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"service",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"proto_arguments",kind:"message",T:i.Any},{no:5,name:"initial_page_atlasservlet",kind:"scalar",T:9},{no:6,name:"initial_page_name",kind:"scalar",T:9}]));class z extends i.Message{constructor(e){super(),this.cssPaths=[],i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new z).fromBinary(e,t)}static fromJson(e,t){return(new z).fromJson(e,t)}static fromJsonString(e,t){return(new z).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(z,e,t)}}z.runtime=i.proto3,z.typeName="edison_dws2.EdisonRequest.CssPreload",z.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"css_paths",kind:"scalar",T:9,repeated:!0}]));class $ extends i.Message{constructor(e){super(),this.modulePaths=[],i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new $).fromBinary(e,t)}static fromJson(e,t){return(new $).fromJson(e,t)}static fromJsonString(e,t){return(new $).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals($,e,t)}}$.runtime=i.proto3,$.typeName="edison_dws2.EdisonRequest.ModulePreload",$.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"module_paths",kind:"scalar",T:9,repeated:!0}]));class G extends i.Message{constructor(e){super(),this.encodedProto="",i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new G).fromBinary(e,t)}static fromJson(e,t){return(new G).fromJson(e,t)}static fromJsonString(e,t){return(new G).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(G,e,t)}}G.runtime=i.proto3,G.typeName="edison_dws2.InitProps",G.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"encodedProto",kind:"scalar",T:9}]));class K extends i.Message{constructor(e){super(),this.modules=[],this.yapsProject="",this.yapsDeployment="",i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new K).fromBinary(e,t)}static fromJson(e,t){return(new K).fromJson(e,t)}static fromJsonString(e,t){return(new K).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(K,e,t)}}K.runtime=i.proto3,K.typeName="datamodules.DataModulesPrefetchArguments",K.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"modules",kind:"scalar",T:9,repeated:!0},{no:3,name:"yaps_project",kind:"scalar",T:9},{no:4,name:"yaps_deployment",kind:"scalar",T:9}]));class X extends i.Message{constructor(e){super(),this.type={case:void 0},i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new X).fromBinary(e,t)}static fromJson(e,t){return(new X).fromJson(e,t)}static fromJsonString(e,t){return(new X).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(X,e,t)}}X.runtime=i.proto3,X.typeName="datamodules.JsonOrProtoAny",X.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"json",kind:"scalar",T:9,oneof:"type"},{no:2,name:"proto_any",kind:"message",T:i.Any,oneof:"type"}]));class Q extends i.Message{constructor(e){super(),this.name="",i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new Q).fromBinary(e,t)}static fromJson(e,t){return(new Q).fromJson(e,t)}static fromJsonString(e,t){return(new Q).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(Q,e,t)}}Q.runtime=i.proto3,Q.typeName="datamodules.DataModule",Q.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"data",kind:"message",T:X}]));class Y extends i.Message{constructor(e){super(),this.dataModules=[],i.proto3.util.initPartial(e,this)}static fromBinary(e,t){return(new Y).fromBinary(e,t)}static fromJson(e,t){return(new Y).fromJson(e,t)}static fromJsonString(e,t){return(new Y).fromJsonString(e,t)}static equals(e,t){return i.proto3.util.equals(Y,e,t)}}Y.runtime=i.proto3,Y.typeName="datamodules.DataModulesPrefetchData",Y.fields=i.proto3.util.newFieldList((()=>[{no:1,name:"data_modules",kind:"message",T:Q,repeated:!0}])),function(e){e[e.DATA=0]="DATA"}(k||(k={}));function Z(e,t,r={}){if(e)return;const n=new Error(`Assertion Error: ${t}`),{tags:s=[],exc_extra:i=null}=r;throw n.assertOptions={tags:s.concat("module:exception","assert"),exc_extra:i},n.isAssertion=!0,n}const ee=/^(?:([^:\/\\?#]+):)?(?:[\/\\]{2}([^\/\\?#]*))?([^?#]*)(?:\?([^#]*))?(?:[#](.*))?$/,te=/^[a-zA-Z][a-zA-Z0-9+.\-]*$/;class re{constructor(e={}){this.dict={},this.add(e)}static parseString(e){if(!e)return{};const t={};return e.split("&").forEach((e=>{if(""!==e){const r=e.split("="),n=re.decode(r[0]),s=re.decode(r.slice(1).join("="));if(t.hasOwnProperty(n)){const e=t[n];let r;r="string"==typeof e?[e]:void 0===e?[]:e,r.push(s),t[n]=r}else t[n]=s}})),t}add(e,t){if("string"==typeof e)t&&(Array.isArray(t)?this.dict[e]=t.map(String):this.dict[e]=String(t));else for(const t in e)if(e.hasOwnProperty(t)){const r=e[t];null!=r&&(Array.isArray(r)?this.dict[t]=r.map(String):this.dict[t]=String(r))}return this}remove(e){return delete this.dict[e],this}replace(e){return this.dict=e,this}toString(e){const t=[],r=Object.keys(this.dict).sort(e);for(const e of r)if(this.dict.hasOwnProperty(e)){const r=this.dict[e];Array.isArray(r)?r.forEach((r=>{t.push(re.encode(e)+"="+re.encode(r))})):t.push(re.encode(e)+"="+re.encode(r))}return t.length?t.join("&"):""}static decode(e){return null==e?"":ne.decode(e.replace(/\+/g,"%20"))}static encode(e){return null==e?"":ne.encode(e).replace(/%20/g,"+")}}class ne{constructor(e={}){this.query=new re,this.initFromObject(e)}initFromObject(e){this.setScheme(e.scheme),this.authority=e.authority||"",this.path=e.path||"",this.setQuery(e.query),this.fragment=e.fragment||""}getScheme(){return this.scheme}getAuthority(){return this.authority}getPath(){return this.path}getQuery(){return this.query.dict}getFragment(){return this.fragment}setScheme(e=""){return Z(!e||Boolean(e.match(te)),"Invalid scheme",{exc_extra:{scheme_param:e}}),this.scheme=e,this}setAuthority(e=""){return this.authority=e,this}setPath(e=""){return this.path=e,this}setQuery(e={}){return this.query=new re(e),this}setFragment(e=""){return this.fragment=e,this}updateQuery(e,t){return this.query.add(e,t),this}removeQuery(e){return this.query.remove(e),this}clone(){return new ne(this.toObject())}toObject(){return{scheme:this.getScheme(),authority:this.getAuthority(),path:this.getPath(),query:this.getQuery(),fragment:this.getFragment()}}toString(e){let t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+ne.encode(this.authority,":@[]")),t+this.toRelativeUri(e)}toRelativeUri(e){let t="";this.path&&(Z(!this.authority||!this.path.length||"/"===this.path[0],'Path must start with a "/" if URI is not relative'),t+=ne.encode(this.path,"/"));const r=this.query.toString(e);return r&&(t+="?"+r),this.fragment&&(t+="#"+ne.encode(this.fragment,":@[]/&=+?#!")),t}static parse(e){const t=String(e).match(ee)||[],[,r,n,s,i,o]=t,a=new ne;return a.setScheme(r),a.setAuthority(ne.decode(n)),a.setPath(ne.decode(s)),a.setQuery(re.parseString(i)),a.setFragment(ne.decode(o)),a}static decode(e){return e?decodeURIComponent(e):""}static encode(e,t=""){if(!e)return"";e=encodeURIComponent(e),t+="~";for(const r of t){const t=encodeURIComponent(r);e=e.replace(new RegExp(t,"g"),r)}return e}static encode_parts(e,t="/"){return e.split(t).map((e=>ne.encode(e))).join(t)}}function se(e){return Z(e.startsWith("/static/"),`'${e}' is not a /static url`),new ne({scheme:"https",authority:"cfl.dropboxstatic.com",path:e}).toString()}ne.Query=re;const ie="Edison not initialized.";var oe;t.EdisonPrefetchStatus=void 0,(oe=t.EdisonPrefetchStatus||(t.EdisonPrefetchStatus={}))[oe.PendingStreaming=0]="PendingStreaming",oe[oe.PendingAjax=1]="PendingAjax",oe[oe.StreamedAndNotConsumed=2]="StreamedAndNotConsumed",oe[oe.StreamedAndConsumed=3]="StreamedAndConsumed",oe[oe.FetchedByAjax=4]="FetchedByAjax";const ae=new i.Empty,de=["acquisition_eng.AcquisitionEdison","affected_links.AffectedLinksPrefetchService","app_directory_edison.AppDirectoryEdison","cx_technology.UWSEdison","dropins.DropinsEmbedEdison","edison_examples.Prefetches","photos_web.PhotosWebEdisonPrefetchService","privacy_consent_edison.PrivacyConsentEdisonPrefetchService","prodsec.SecurityCheckupEdison","signup_signin.MagicLinkEdisonPrefetch","space_upsells.SpaceUpgradeEdison","warp.ExperienceFragmentServicer","web_platform.WebPlatformTestEdisonPrefetchService","web_platform.WebPlatformEdisonFetch","web_platform.WebPlatformEdisonTestPrefetchAsync"];class ce{setEntryInPrefetchLog(e,t,r,n){for(const s of this.prefetchLog)if(s.requestKey===e&&s.status===t)return s.status=r,void(n&&Object.assign(s,n))}constructor(e,t){this.isDoneStreaming=!1,this.isServerSidePrefetchStarted=!1,this.loadedDataModules={},this.pendingDataModulePromises={},this.pendingDataModuleResolveFns={},this.consumedPrefetches={},this.pendingPrefetchPromises={},this.pendingPrefetchResolveFns={},this.pendingServerSidePrefetchKeys=[],this.numPrefetchesRequestedBeforeDoneStreaming=0,this.numPrefetchesRequestedAfterDoneStreaming=0,this.numPrefetchesByAjax=0,this.numPrefetchesStreamed=0,this.prefetchLog=[],this.preloadedCssPaths=new Set,this.initParams=e;const{pageName:r}=e,{getLazyMetricsReporter:n}=t;this.metrics=new j({pageName:r,getLazyMetricsReporter:n})}static initialized(){return!!ce.instance}static waitUntilInitialized(){return r.__awaiter(this,void 0,void 0,(function*(){yield ce.initializedPromise}))}static init(e,t={}){if(ce.instance)throw new Error("Edison is already initialized.");const{activeUserId:r,pageName:n,rpcProxyUrl:s}=e;if(!s&&!window.RUNNING_IN_REACTSERVER)throw new Error("rpcProxyUrl init param missing. This is required for the browser environment.");ce.instance=new ce(e,t),ce.instance.metrics.recordInitReceived(),window.RUNNING_IN_EDISON=!0,window.EDISON_ACTIVE_USER_ID=Number(r)>0?Number(r):void 0,window.EDISON_PAGE_NAME=n,ce.initializedResolveFn()}static reset(){ce.instance=null}static beforeRender(e){const{beforeRenderModuleName:t}=ce.getInitParams(),{beforeRender:r}=e;if(!r)throw new Error(`Module '${t}' does not export a beforeRender function.`);if("function"!=typeof r)throw new Error(`beforeRender member exported from '${t}' is not a function.`);e.beforeRender()}static render(e,t=!1,r=""){const{entryPointModuleName:n}=ce.getInitParams();if(!e.RootComponent)throw new Error(`Module '${n}' does not export a React component named RootComponent.`);let s={};if(r&&r.length>0){const{encodedProto:e}=U(r,G);s={encodedProto:e}}const i=a.default.createElement(e.RootComponent,s),o="root";let c=document.getElementById(o);null===c&&(c=document.createElement("div"),c.id=o,document.body.appendChild(c));const l=ce.instance;l.metrics.recordRenderStarted(),t?d.default.hydrate(i,c,(()=>{l.metrics.recordRenderComplete()})):d.default.render(i,c,(()=>{l.metrics.recordRenderComplete()}))}static getInitParams(){if(!ce.instance)throw new Error(ie);return ce.instance.initParams}static getAtlasservlet(){return ce.getInitParams().atlasservlet}static getAttribution(){const{atlasservlet:e,pageLifecycle:t}=ce.getInitParams();return`${e}:${t}`}static getPageName(){return ce.getInitParams().pageName}static getPageLifecycle(){return ce.getInitParams().pageLifecycle}static getIsOfficeIp(){return ce.getInitParams().isOfficeIp}static getActiveUserId(){return Number(ce.getInitParams().activeUserId)}static getActiveTeamId(){return Number(ce.getInitParams().activeTeamId)}static getLegacyController(){return ce.getInitParams().legacyController}static getLegacyAction(){return ce.getInitParams().legacyAction}static isStreamingEnabled(){return ce.getInitParams().streamingEnabled}static isDoneStreaming(){var e;return(null===(e=ce.instance)||void 0===e?void 0:e.isDoneStreaming)||!1}static getStaticRepoRev(){return ce.getInitParams().staticRepoRev}static getDws2RepoRev(){return ce.getInitParams().dws2RepoRev}static getIsBuildTimePrefetchesEnabled(){return ce.getInitParams().isBuildTimePrefetchesEnabled}static getIsDws2Stage(){return ce.getInitParams().isDws2Stage}static getEntryPointModuleName(){return ce.getInitParams().entryPointModuleName}static getOriginalUrl(){return ce.getInitParams().originalUrl}static getOriginalReferer(){return ce.getInitParams().originalReferer}static getPrefetchLog(){if(!ce.instance)throw new Error(ie);return[...ce.instance.prefetchLog]}static getPrefetchVersion(){return ce.getInitParams().prefetchVersion||0}static getIsProd(){return ce.getInitParams().isProd}static getMetrics(){if(!ce.instance)throw new Error(ie);return ce.instance.metrics}static getEdisonFeatureGates(){return ce.getInitParams().gates||{}}static _grpcWebAjax(e,r){return _(),new Promise(((n,s)=>{const o=ce.getEdisonFeatureGates(),{rpcProxyUrl:a,atlasservlet:d,pageName:c,originalUrl:l,originalReferer:u,legacyController:m,legacyAction:h}=ce.getInitParams(),g=ce.instance,p=new XMLHttpRequest;p.responseType="arraybuffer";const f=function(e){if("serviceMethodPrefetch"===e.type.case)return`${e.type.value.service}/${e.type.value.method}`;throw new Error(`unsupported request type: ${e.type.case}`)}(e),{service:w,protoArguments:v}=e.type.value;o.enable_grpc_web&&de.indexOf(w)>=0?(p.open("POST",`/web-grpc/edison/${f}`,!0),p.setRequestHeader("X-Dropbox-Authority",window.location.host)):p.open("POST",`${a}/${f}`,!0),p.setRequestHeader("Content-Type","application/grpc-web+proto"),p.setRequestHeader("Accept-Language",document.documentElement.lang),p.setRequestHeader("X-Grpc-Web","1"),p.setRequestHeader("X-Edison-Atlasservlet",d),p.setRequestHeader("X-Edison-Page-Name",c),p.setRequestHeader("X-Edison-Original-Url",l),p.setRequestHeader("X-Edison-Original-Referer",u),p.setRequestHeader("X-Edison-Prompt-Controller",m),p.setRequestHeader("X-Edison-Prompt-Action",h),p.setRequestHeader("X-Dropbox-Client-Yaps-Attribution",ce.getAttribution()),p.setRequestHeader("X-Edison-No-Any","true"),ce.addAuthHeaders(p),p.onload=()=>{if(200!==p.status){const e="gRPC Web request returned a non-200 status code. Check the server logs.";return g.setEntryInPrefetchLog(r,t.EdisonPrefetchStatus.PendingAjax,t.EdisonPrefetchStatus.FetchedByAjax,{failed:!0,result:e}),void s(new Error(e))}if(p.response.byteLength<5){const e="gRPC Web request returned no content. Check the server logs.";return g.setEntryInPrefetchLog(r,t.EdisonPrefetchStatus.PendingAjax,t.EdisonPrefetchStatus.FetchedByAjax,{failed:!0,result:e}),void s(new Error(e))}const e=function(e){const t=new Uint8Array(e);let r=0;for(let e=1;e<5;e++)r=(r<<8)+t[e];return t.subarray(5,5+r)}(p.response),o=i.protoBase64.enc(e);g.setEntryInPrefetchLog(r,t.EdisonPrefetchStatus.PendingAjax,t.EdisonPrefetchStatus.FetchedByAjax,{failed:!1,result:o}),n(o)},p.onerror=()=>{const e="gRPC Web request failed. Check the server logs.";g.setEntryInPrefetchLog(r,t.EdisonPrefetchStatus.PendingAjax,t.EdisonPrefetchStatus.FetchedByAjax,{failed:!0,result:e}),s(new Error(e))};const E=function(e){const t=new Uint8Array(5+e.length);t[0]=k.DATA;for(let r=e.length,n=4;n>0;n--)t[n]=r%256,r>>>=8;return t.set(e,5),t}(v.value);p.send(E)})).finally(S)}static getAuthHeaders(){const e={},{activeUserId:t,activeTeamId:r,authRole:n,authActionType:s}=ce.getInitParams();return t&&(e["X-Dropbox-Uid"]=t.toString()),r&&(e["X-Dropbox-Teamid"]=r.toString()),(n||s)&&(e["X-Dropbox-Team-Authorization"]=JSON.stringify({auth_role:String(n),auth_action_type:String(s)})),e}static addAuthHeaders(e){for(const[t,r]of Object.entries(ce.getAuthHeaders()))e.setRequestHeader(t,r)}static preloadCSS(e){if(!ce.instance)throw new Error(ie);const t=ce.instance,r=window;if(window.RUNNING_IN_REACTSERVER){const n=[];for(const r of e)t.preloadedCssPaths.has(r)||(n.push(r),t.preloadedCssPaths.add(r));if(n.length>0){const e=F(new H({type:{case:"cssPreload",value:{cssPaths:n}}}));r.ReactserverEdisonClient.sendEdisonRequest(e)}}else{t.metrics.recordCssPreloadReceived();const r=document,n=x(r);e.forEach((e=>{const t=se(e);N(r,n,e,t,"edison:preloadCss")}))}}static serviceMethodPrefetch(e,r,n){if(!ce.instance)throw new Error(ie);const{atlasservlet:s,pageName:o}=ce.getInitParams(),a=new H({type:{case:"serviceMethodPrefetch",value:{service:e,method:r,protoArguments:(d=n||ae,new i.Any({typeUrl:c,value:d.toBinary()})),initialPageAtlasservlet:s,initialPageName:o}}});var d,c;const l=`${e}.${r}`,u=ce.instance;if(u.isDoneStreaming?u.numPrefetchesRequestedAfterDoneStreaming++:u.numPrefetchesRequestedBeforeDoneStreaming++,a.b64RequestKey)throw new Error("The EdisonRequest proto message parameter to prefetchHelper must not have a b64PrefetchKey set (it is computed here so we make sure it is the same between browser and streaming reactserver).");const m=F(a),h=!!u.pendingPrefetchPromises[m];return!u.initParams.streamingEnabled||u.consumedPrefetches[m]||u.isServerSidePrefetchStarted&&!u.pendingServerSidePrefetchKeys.includes(m)&&!h||u.isDoneStreaming&&!h?(u.numPrefetchesByAjax++,u.prefetchLog.push({edisonRequest:a,requestKey:m,status:t.EdisonPrefetchStatus.PendingAjax}),ce._grpcWebAjax(a,m)):(h?u.setEntryInPrefetchLog(m,t.EdisonPrefetchStatus.StreamedAndNotConsumed,t.EdisonPrefetchStatus.StreamedAndConsumed):(u.pendingPrefetchPromises[m]=new Promise(((e,t)=>{u.pendingPrefetchResolveFns[m]={requestMsg:a,resolve:e,reject:t}})),u.prefetchLog.push({edisonRequest:a,requestKey:m,status:t.EdisonPrefetchStatus.PendingStreaming})),u.metrics.recordStreamedPrefetchRequestTime(m,l),u.consumedPrefetches[m]=!0,u.pendingPrefetchPromises[m])}static fetch(e,t,r){const{originalUrl:n}=ce.getInitParams(),s=Object.assign({originalUrl:n},r||{});s.currentUrl=s.currentUrl||n;const i=ce.getPrefetchVersion()>0?new B(s):void 0;return this.serviceMethodPrefetch(e,t,i)}static preloadJSModules(e){if(window.RUNNING_IN_REACTSERVER){const t=F(new H({type:{case:"modulePreload",value:{modulePaths:e}}}));window.ReactserverEdisonClient.sendEdisonRequest(t)}}static registerStreamedPrefetch(e,r,n=!1){if(!ce.instance)throw new Error(ie);const s=ce.instance;if(!s.initParams.streamingEnabled)throw new Error("Edison must be initialized with streaming enabled to handle streaming prefetches.");if(s.isDoneStreaming)throw new Error("Cannot register new streamed prefetch after marking that we are done streaming.");if(s.metrics.recordStreamedPrefetchResponseTime(e,n),s.numPrefetchesStreamed++,!s.pendingPrefetchPromises[e]){s.pendingPrefetchPromises[e]=n?Promise.reject(new Error(r)):Promise.resolve(r);const i=U(e,H),o={requestKey:e,status:t.EdisonPrefetchStatus.StreamedAndNotConsumed,failed:n,result:r};return i&&(o.edisonRequest=i),void s.prefetchLog.push(o)}s.pendingPrefetchResolveFns[e]&&(n?s.pendingPrefetchResolveFns[e].reject(new Error(r)):s.pendingPrefetchResolveFns[e].resolve(r),delete s.pendingPrefetchResolveFns[e],s.setEntryInPrefetchLog(e,t.EdisonPrefetchStatus.PendingStreaming,t.EdisonPrefetchStatus.StreamedAndConsumed,{result:r,failed:n}))}static loadDataModule(e){if(!ce.instance)throw new Error(ie);const t={};for(const r of e)r in ce.instance.loadedDataModules&&(t[r]=ce.instance.loadedDataModules[r]);if(Object.keys(t).length===e.length)return Promise.resolve(t);{const r=e.filter((e=>!(e in ce.instance.loadedDataModules)));return ce.serviceMethodPrefetch("data_modules.DataModules","DataModulesPrefetch",new K({modules:r})).then((e=>{const n=U(e,Y).dataModules;if(n.length!==r.length)throw new Error("unexpected number of data modules in the response -- we should have received exactly "+r.length+" but instead we got "+n.length);for(const{data:e,name:r}of n){if(!e||"json"!==e.type.case||!e.type.value)throw new Error("handling data modules with protobuf return type not yet implemented");{const n=JSON.parse(e.type.value);ce.instance.loadedDataModules[r]=n,t[r]=n}}return t}))}}static registerStreamedDataModule(e,t,r){if(!ce.instance)throw new Error(ie);const n=ce.instance;if(n.isDoneStreaming)throw new Error("Cannot register new streamed data modules after marking that we are done streaming.");if("proto"===t)throw new Error("handling data modules with protobuf return type not yet implemented");n.metrics.recordDataModuleReceived();const s=JSON.parse(r);if(n.pendingDataModulePromises[e]){if(!n.pendingDataModuleResolveFns[e])throw new Error(`Trying to resolve the promise for the streamed data module "${e}" but could not find resolve function in pendingDataModuleResolveFns`);n.pendingDataModuleResolveFns[e].resolve(s),delete n.pendingDataModuleResolveFns[e]}else n.pendingDataModulePromises[e]=Promise.resolve(s)}static getStreamedDataModule(e){if(!ce.instance)throw new Error(ie);const t=ce.instance;if(!t.initParams.streamingEnabled)throw new Error("Edison must be initialized with streaming enabled to get data modules streamed in page response.");if(!t.pendingDataModulePromises[e]){if(t.isDoneStreaming)throw new Error(`Data module "${e}" was not streamed.`);t.pendingDataModulePromises[e]=new Promise(((r,n)=>{t.pendingDataModuleResolveFns[e]={resolve:r,reject:n}}))}return t.pendingDataModulePromises[e]}static markServerSidePrefetchStarted(e){if(!ce.instance)throw new Error(ie);if(!Array.isArray(e))throw new Error("requestKeys must be an array");const r=ce.instance;r.isServerSidePrefetchStarted=!0,r.pendingServerSidePrefetchKeys=e,r.metrics.recordServerSidePrefetchStartedReceived();Object.keys(r.pendingPrefetchResolveFns).filter((t=>!e.includes(t))).forEach((e=>{const{requestMsg:n,resolve:s,reject:i}=r.pendingPrefetchResolveFns[e];r.setEntryInPrefetchLog(e,t.EdisonPrefetchStatus.PendingStreaming,t.EdisonPrefetchStatus.PendingAjax),ce._grpcWebAjax(n,e).then(s).catch(i),delete r.pendingPrefetchResolveFns[e],r.numPrefetchesByAjax++}))}static doneStreaming(){if(!ce.instance)throw new Error(ie);const e=ce.instance;if(!e.initParams.streamingEnabled)throw new Error("Cannot stop processing streaming chunks if Edison is not initialized with streaming enabled.");if(!e.isDoneStreaming){e.metrics.recordDoneStreamingReceived(),e.metrics.saveEventTimings();for(const t in e.pendingDataModuleResolveFns){if(t in e.loadedDataModules)throw new Error(`${t} was still pending registration by streamed inline chunks at time of "done streaming", but there already is a result for this data module being loaded already. This is an invalid state.`);e.pendingDataModuleResolveFns[t].reject(new Error("canceling data module progress: done streaming before receiving data module result")),delete e.pendingDataModuleResolveFns[t]}for(const r in e.pendingPrefetchResolveFns)if(e.pendingPrefetchResolveFns.hasOwnProperty(r)){const{requestMsg:n,resolve:s,reject:i}=e.pendingPrefetchResolveFns[r];e.setEntryInPrefetchLog(r,t.EdisonPrefetchStatus.PendingStreaming,t.EdisonPrefetchStatus.PendingAjax),ce._grpcWebAjax(n,r).then(s).catch(i),delete e.pendingPrefetchResolveFns[r],e.numPrefetchesByAjax++}e.pendingServerSidePrefetchKeys=[],e.isDoneStreaming=!0}}static getPrefetchCounts(){if(!ce.instance)throw new Error(ie);const e=ce.instance;return{numPrefetchesRequestedAfterDoneStreaming:e.numPrefetchesRequestedAfterDoneStreaming,numPrefetchesRequestedBeforeDoneStreaming:e.numPrefetchesRequestedBeforeDoneStreaming,numPrefetchesByAjax:e.numPrefetchesByAjax,numPrefetchesStreamed:e.numPrefetchesStreamed}}}ce.instance=null,ce.initializedPromise=new Promise((e=>{ce.initializedResolveFn=e}));var le=Object.freeze({__proto__:null,Edison:ce,get EdisonPrefetchStatus(){return t.EdisonPrefetchStatus}});function ue(){return r.__awaiter(this,void 0,void 0,(function*(){const{getMetricsReporter:t}=yield new Promise((function(t,r){e(["./c_src_sink_index"],t,r)})).then((function(e){return e.index_esnext}));return t()}))}function me(){return r.__awaiter(this,void 0,void 0,(function*(){const{ensureCookiesAreEnabled:t}=yield new Promise((function(t,r){e(["./c_edison_cookies_check"],t,r)}));if(!t())return;(()=>{r.__awaiter(this,void 0,void 0,(function*(){const{showToastFromCookie:t}=yield new Promise((function(t,r){e(["./c_core_toast_toast_on_init"],t,r)}));t()}))})()}))}t.Edison=ce,t.URI=ne,t.assert=Z,t.decrementAjaxCount=S,t.edison_esnext=le,t.getOrCreateCache=x,t.incrementAjaxCount=_,t.init=e=>{var t;(e=>{(null==e?void 0:e.debug)&&(c.DEBUG=e.debug),(null==e?void 0:e.idleTimeout)&&(c.IDLE_TIMEOUT=e.idleTimeout),(null==e?void 0:e.networkTimeout)&&(c.NETWORK_TIMEOUT=e.networkTimeout)})(e),l.info("init()"),y||(y=new P),T=y,t=()=>{T.start(),window.addEventListener("locationchange",(e=>{T.start(e.timeStamp)})),window.addEventListener("pageshow",(e=>{e.persisted&&T.start(e.timeStamp,!0)}))},document.prerendering?window.addEventListener("prerenderingchange",t,!0):t()},t.initFromDws=function(e){ce.init(e),me()},t.initPage=function(e){const t="string"==typeof e?U(e,V):V.fromJson(e);window.RUNNING_IN_REACTSERVER?ce.init(t):(ce.init(t,{getLazyMetricsReporter:ue}),me())},t.injectCss=O,t.loadCssWithCache=N,t.onTTVC=(e,t)=>null==T?void 0:T.onTTVC(e,t),t.render=function(e,t=!1,r=""){if(!e.RootComponent)throw new Error(`Module '${ce.getEntryPointModuleName()}' does not export a React component named RootComponent.`);let n={};if(r&&r.length>0){const{encodedProto:e}=U(r,G);n={encodedProto:e}}const s=a.default.createElement(e.RootComponent,n),i="root";let o=document.getElementById(i);null===o&&(o=document.createElement("div"),o.id=i,document.body.appendChild(o));const c=ce.getMetrics();c.recordRenderStarted(),t?d.default.hydrate(s,o,(()=>{c.recordRenderComplete()})):d.default.render(s,o,(()=>{c.recordRenderComplete()}))},t.rescanForMoreCssLinks=A,t.static_url=se,t.unmarshalProto=U}));
//# sourceMappingURL=e_edison.js-vflJota6T.map
