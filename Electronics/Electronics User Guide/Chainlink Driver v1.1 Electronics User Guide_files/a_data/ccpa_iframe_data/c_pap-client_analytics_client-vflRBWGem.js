define(["exports","./e_privacy_consent_static_ccpa_iframe","metaserver/static/js/modules/constants/auth","./c_tslib","./c_src_sink_index","./c_apex-metrics_src_types"],(function(e,t,n,s,r,i){"use strict";function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var c=o(n);class a{executeRpc(e,n,s,r){var i;const o=null===(i=navigator.sendBeacon)||void 0===i?void 0:i.bind(navigator);if(o)return new Promise((function(i,c){var a;const d=function(e,n){const s=t.sjclExports.codec.utf8String.toBits(e),r=new t.sjclExports.misc.hmac(s,t.sjclExports.hash.sha256).encrypt(n);return t.sjclExports.codec.base64url.fromBits(r)}(null!==(a=n[t.ApiV2HeaderNames.CsrfToken])&&void 0!==a?a:"",e.getPath());e.updateQuery({t:d});const l=new Blob([s,JSON.stringify(Object.assign(Object.assign({},n),{"Content-Type":r}))],{type:r}),u=o(e.toString(),l),p={result:JSON.parse(JSON.stringify({beacon:u})),headers:n};return u?i(p):c(p)}));return(new t.FetchAsyncTransport).executeRpc(e,n,s,r)}executeBinaryRpc(e,n,s,r){return(new t.FetchAsyncTransport).executeBinaryRpc(e,n,s,r)}}function d(e){return e.replace(/[A-Z]/g,((e,t)=>0===t?e.toLowerCase():"_"+e.toLowerCase()))}function l(e,t=25){let n="";const s=e.toLowerCase().split(/\s+/).join("-");for(const e of s){if(n.length>=t)break;const s=e.charCodeAt(0);(s>47&&s<58||s>96&&s<123||45===s&&"-"!==n[n.length-1])&&(n+=e)}return"-"===n[n.length-1]&&(n=n.slice(0,n.length-1)),n}function u(){const e=/([^(]+)@|at ([^(]+) \(/,t=new Error;if(void 0===t.stack)return"unknown";let n="";return t.stack.split("\n").slice(3,7).forEach((t=>{const s=e.exec(t);n+="/"+(null===s?"?":(s[1]||s[2]).replace("<anonymous>","?"))})),n.substring(0,64)}const p=["actionSurface","eventClass","eventState"];function v(e){if("class"in e&&"action"in e&&"object"in e)return e}function h(e){const t=v(e);return t?t.class:S(e,"eventClass",0)}function g(e){const t=f(e),n=m(e);if(void 0!==t&&void 0!==n)return t+"."+n}function f(e){var t;const n=v(e);if(n)return n.action;try{const n=null===(t=e.constructor)||void 0===t?void 0:t.getTypeUrl().split(".").pop();return d(null==n?void 0:n.split("_")[0])}catch(e){}}function m(e){var t;const n=v(e);if(n)return n.object;try{const n=null===(t=e.constructor)||void 0===t?void 0:t.getTypeUrl().split(".").pop();return d(null==n?void 0:n.split("_")[1])}catch(e){}}function _(e){var t;const n=v(e);return n?null===(t=n.properties)||void 0===t?void 0:t.actionSurface:null==e?void 0:e.actionSurface}function w(e){var t,n;return(null===(n=null===(t=v(e))||void 0===t?void 0:t.properties)||void 0===n?void 0:n.eventState)||"unknown_event_state"}function y(e){return".tag"in e&&"stormcrow_exposure_event"===e[".tag"]}function b(e){const t={},n=v(e);if(n)for(const e in n.properties)-1===p.indexOf(e)&&n.properties.hasOwnProperty(e)&&void 0!==n.properties[e]&&(t[d(e)]=n.properties[e].toString());else for(const n in e)if(-1===p.indexOf(n)&&e.hasOwnProperty(n)){const s=S(e,n);t[d(n)]=s||e[n].toString()}return t}function S(e,t,n){var s;if(!t||!t.length)return;const r=t.charAt(0).toUpperCase()+t.substring(1),i=(null===(s=e.constructor)||void 0===s?void 0:s[r])||{},o=e[t]||n;for(const e of Object.keys(i))if(parseInt(i[e],10)===o)return e.toLowerCase()}const R={CRITICAL:"critical",NONCRITICAL:"non-critical",USER_ERROR:"user-error",UNCAUGHT:"uncaught",OPERATIONAL:"operational"};function E(e,t){const n=new Error(e),s={force:!0,severity:(null==t?void 0:t.severity)||R.NONCRITICAL,tags:(null==t?void 0:t.tags)||["pap_web"]};O(Object.assign({err:n},s))}function O(e){const{err:t}=e;t.tags=[...(null==t?void 0:t.tags)||[],...(null==e?void 0:e.tags)||["pap_web"]],t.severity=e.severity,t.force=e.force,"undefined"==typeof jest&&setTimeout((()=>{throw t}),0)}const j={apiv2:"apiv2",fetch:"fetch",sdk:"sdk"},C="pap_event_logging",I="log_events";function F(e,t){return s.__awaiter(this,void 0,void 0,(function*(){switch(t.type){case j.fetch:return t.fetch(`/2/${C}/${I}`,{method:"POST",body:JSON.stringify({event_entries:e}),headers:{"Content-Type":"application/json"}});case j.apiv2:return t.apiV2Client.ns(C).rpc(I,{event_entries:e},{});case j.sdk:return t.sdk.papEventLoggingLogEvents({event_entries:e})}}))}const x=(()=>{let e,t;const n=[];for(e=0,t=e;e<=255;e++,t=e)n.push((t+256).toString(16).substr(1));return n})();function P(e){return e.map((e=>x[e])).join("")}const q={getRandomBytes(){const e=new Uint8Array(16);return window.crypto&&window.crypto.getRandomValues(e),e},v4(){const e=this.getRandomBytes();e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.prototype.slice.call(e);return[t.slice(0,4),t.slice(4,6),t.slice(6,8),t.slice(8,10),t.slice(10,16)].map(P).join("-")}};function A(e){const{identity:t}=e;return(null==t?void 0:t.foreignUserProvider)&&(null==t?void 0:t.foreignUserId)?{foreign_user_provider:null==t?void 0:t.foreignUserProvider,foreign_user_id:null==t?void 0:t.foreignUserId,user_id:void 0,team_id:void 0,paired_user_id:void 0}:(null==t?void 0:t.foreignUserProvider)&&!(null==t?void 0:t.foreignUserId)||!(null==t?void 0:t.foreignUserProvider)&&(null==t?void 0:t.foreignUserId)?((null==t?void 0:t.foreignUserId)?(null==t?void 0:t.foreignUserProvider)||E("Missing foreign_user_provider"):E("Missing foreign_user_id"),{foreign_user_provider:null==t?void 0:t.foreignUserProvider,foreign_user_id:null==t?void 0:t.foreignUserId,user_id:null==t?void 0:t.userId,team_id:null==t?void 0:t.teamId,paired_user_id:null==t?void 0:t.pairedUserId}):{user_id:null==t?void 0:t.userId,team_id:null==t?void 0:t.teamId,paired_user_id:null==t?void 0:t.pairedUserId}}function T(e,t,n,s){var r,i,o,c,a;return{application_fields:{build_channel:{".tag":"stable"},product_name:{".tag":t.application.productName}},device_fields:{locale:navigator.languages&&navigator.languages.length>0?navigator.languages[0]:navigator.language,platform_fields:{".tag":"client_web_device_fields",ua_browser_lang:null===(r=null==s?void 0:s.navigator)||void 0===r?void 0:r.language,is_br_cookies_enabled:null===(i=null==s?void 0:s.navigator)||void 0===i?void 0:i.cookieEnabled,ua_br_color_depth:null===(o=null==s?void 0:s.screen)||void 0===o?void 0:o.colorDepth,ua_br_viewport_width:null==s?void 0:s.innerWidth,ua_br_viewport_height:null==s?void 0:s.innerHeight,device_screen_height:null===(c=null==s?void 0:s.screen)||void 0===c?void 0:c.height,device_screen_width:null===(a=null==s?void 0:s.screen)||void 0===a?void 0:a.width,url:null==s?void 0:s.location.href,referrer:null===document||void 0===document?void 0:document.referrer,request_id:n.requestId}},client_identity_fields:A(t),events:e.map((({payload:e,ts:t,sessionId:n})=>function(e,t,n){return y(e)?{event_identifier:e,event_ts:new Date(t).toISOString(),platform_session_id:n,event_guid:q.v4()}:{event_identifier:{event_action:f(e),event_object:m(e),".tag":"predefined_event"},event_properties:b(e),event_ts:new Date(t).toISOString(),action_surface:_(e),event_class:h(e),event_state:{".tag":w(e)},platform_session_id:n,event_guid:q.v4()}}(e,t,n)))}}const U="pap_session_value",B="pap_session_last_used";class k{constructor(e){this.events=[],this.metricsReporter=e.metricsReporter,this.configMaxSize=(null==e?void 0:e.maxSize)||2e4}dropEvents(e,t){const n=this.popEvents(e);n.forEach((e=>{void 0!==e&&e.options.onFailedToSendEvent&&e.options.onFailedToSendEvent(!1)})),this.metricsReporter.recordEventsDropped(n.length,{reason:null!=t?t:"unknown_reason"})}popEvents(e){return this.events.splice(0,e)}add(e){this.isFull()&&this.dropEvents(this.events.length-this.configMaxSize+1,"queue_full"),this.events.push(e)}requeue(e){this.events.unshift(...e),this.isFull()&&this.dropEvents(this.events.length-this.configMaxSize,"queue_full")}size(){return this.events.length}isEmpty(){return 0===this.events.length}isFull(){return this.events.length>=this.configMaxSize}}class N{constructor(e){this.eventQueueByPersistentFields={},this.configs={},this.transport=e.transport,this.sendBeaconTransport=e.sendBeaconTransport,this.configMaxEventsPerRequest=e.maxEventsPerRequest||2e3,this.metricsReporter=e.metricsReporter,this.populateWindowPropertiesCache(),this.start()}populateWindowPropertiesCache(){this.windowPropertiesCache={navigator:{language:window.navigator.language,cookieEnabled:window.navigator.cookieEnabled},screen:{height:window.screen.height,width:window.screen.width,colorDepth:window.screen.colorDepth},location:{href:window.location.href},innerWidth:window.innerWidth,innerHeight:window.innerHeight}}start(){document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState&&this.flush(!0)})),window.addEventListener("pagehide",(()=>{this.flush(!0)})),this.scheduleFlush(5e3)}add(e,t,n){this.populateWindowPropertiesCache(),function(e){return!!y(e)||void 0!==f(e)&&void 0!==m(e)}(e)||E(`Invalid event name ${g(e)}`);let s=this.eventQueueByPersistentFields[JSON.stringify(n)];void 0===s&&(s=new k({metricsReporter:this.metricsReporter}),this.eventQueueByPersistentFields[JSON.stringify(n)]=s),s.add({payload:e,ts:Date.now(),sendAttempts:0,sessionId:this.getSessionId(),options:t}),t.flush&&this.flush(),this.metricsReporter.recordQueueSize(s.size())}scheduleFlush(e){this.timeoutId=setTimeout((()=>this.flush()),e)}flush(e){var t;return s.__awaiter(this,void 0,void 0,(function*(){this.timeoutId&&clearTimeout(this.timeoutId);let n=3e4;for(const[s,r]of Object.entries(this.eventQueueByPersistentFields)){if(void 0===r||r.isEmpty())continue;const i=r.popEvents(this.configMaxEventsPerRequest);let o=!1;i.forEach((e=>e.sendAttempts++));try{const t=T(i,JSON.parse(s),this.configs,this.windowPropertiesCache),n=this.metricsReporter.createSendEventsTimer({beacon:Boolean(e).toString()});yield F(t,e&&this.sendBeaconTransport?this.sendBeaconTransport:this.transport),n.record(),o=!0}catch(e){O({err:e}),this.metricsReporter.recordRequestsFailed(1,{error_name:(null!==(t=null==e?void 0:e.name)&&void 0!==t?t:null==e?void 0:e.message)?l(e.message):"unknown_error"})}if(this.metricsReporter.recordRequestsEvents(i.length),o)this.metricsReporter.recordRequestsSuccess(1),this.metricsReporter.recordRequestsAttempts(Math.max(...i.map((e=>e.sendAttempts)))),this.metricsReporter.recordEventsSent(i.length),r.isEmpty()||(n=2e3);else{const e=i.filter((e=>(e.options.onFailedToSendEvent&&e.options.onFailedToSendEvent(e.sendAttempts<4),e.sendAttempts<4)));e.length>0&&r.requeue(e);const t=i.length-e.length;t>0&&(this.metricsReporter.recordRequestsAttempts(Math.max(...i.map((e=>e.sendAttempts)))),this.metricsReporter.recordEventsDropped(t,{reason:"hit_max_retries"}))}}this.scheduleFlush(Math.floor(n*(.8+.4*Math.random())))}))}getSessionId(){let e;try{e=window.localStorage}catch(e){return Date.now().toString()}if(!e)return Date.now().toString();const t=e.getItem(B);let n=e.getItem(U);return(!n||!t||parseInt(t,10)<Date.now()-18e5)&&(n=Date.now().toString(),e.setItem(U,n)),e.setItem(B,Date.now().toString()),n}updateConfigs(e){this.configs=Object.assign(Object.assign({},this.configs),e)}}const z="web_product_analytics_pipeline";class D{constructor(e){this.metricsReporter=r.getMetricsReporter({clientFactory:()=>s.__awaiter(this,void 0,void 0,(function*(){return(e=>{switch(e.type){case j.fetch:return r.clientFetchAdaptor(e.fetch);case j.apiv2:return r.clientBaseAdaptor(e.apiV2Client);case j.sdk:return r.clientSDKAdaptor(e.sdk)}})(e.transport)})),originKind:"pap-client"}),this.counterEventsSent=this.metricsReporter.createCounter({ns:z,name:"pap/web/events/sent"}),this.counterRequestsEvents=this.metricsReporter.createCounter({ns:z,name:"pap/web/requests/events"}),this.counterRequestsSuccess=this.metricsReporter.createCounter({ns:z,name:"pap/web/requests/success"}),this.counterRequestsAttempts=this.metricsReporter.createCounter({ns:z,name:"pap/web/requests/attempts"}),this.statsQueueSize=this.metricsReporter.createStats({ns:z,name:"pap/web/events/queued"})}recordEventsDropped(e,t){const n=this.metricsReporter.createCounter({ns:z,name:"pap/web/events/dropped"},t);n.increment(e),n.record()}recordEventsSent(e){this.counterEventsSent.increment(e),this.counterEventsSent.record()}recordRequestsEvents(e){this.counterRequestsEvents.increment(e),this.counterRequestsEvents.record()}recordRequestsSuccess(e){this.counterRequestsSuccess.increment(e),this.counterRequestsSuccess.record()}recordRequestsAttempts(e){this.counterRequestsAttempts.increment(e),this.counterRequestsAttempts.record()}recordRequestsFailed(e,t){const n=this.metricsReporter.createCounter({ns:z,name:"pap/web/requests/failure"},t);n.increment(e),n.record()}recordQueueSize(e){this.statsQueueSize.record(e)}createSendEventsTimer(e){return this.metricsReporter.createTimer({ns:z,name:"analytics-client-logger/events/send-timer"},e)}recordEventStats(e,t,n){const s=this.metricsReporter.createCounter({ns:z,name:"analytics-client-event/"+t+"/"+e},n);s.increment(1),s.record()}recordPerformance(e){const t={latency:this.metricsReporter.createStats({ns:z,name:"pap/web/requests/latency"}),transferSize:this.metricsReporter.createStats({ns:z,name:"pap/web/requests/transfer_size"}),encodedBodySize:this.metricsReporter.createStats({ns:z,name:"pap/web/requests/encoded_body_size"})};t.latency.recordDuration(e.duration,i.TimeUnit.MILLISECONDS),t.transferSize.record(e.transferSize),t.encodedBodySize.record(e.encodedBodySize)}recordPermanentlyFailedEvent(){const e=this.metricsReporter.createCounter({ns:z,name:"pap/web/events/permanently_failed"});e.increment(1),e.record()}}const M={application:{productName:"core_dropbox"}};class L{constructor(e){if(this.resetPersistentFields=()=>this.persistentFields=M,this.getPersistentFields=()=>this.persistentFields,this.setPersistentFields=e=>{var t;this.persistentFields=Object.assign(Object.assign(Object.assign({},this.persistentFields),{application:Object.assign(Object.assign({},this.persistentFields.application),e.application)}),(this.persistentFields.identity||e.identity)&&{identity:Object.assign(Object.assign({},this.persistentFields.identity),null!==(t=e.identity)&&void 0!==t?t:{})})},this.observerCallback=e=>{try{const t=e.getEntriesByName("https://www.dropbox.com/2/pap_event_logging/log_events","resource");for(const e of t)this.metricsReporter.recordPerformance(e)}catch(e){O({err:e,tags:["web_analytics_client"]})}},this.metricsReporter=new D({transport:e.transport}),this.logger=new N({transport:e.transport,sendBeaconTransport:e.sendBeaconTransport,metricsReporter:this.metricsReporter}),this.persistentFields=M,window&&window.PerformanceObserver)try{new window.PerformanceObserver(this.observerCallback).observe({entryTypes:["resource"]})}catch(e){O({err:e,tags:["web_analytics_client"]})}}updateConfigs(e){this.logger.updateConfigs(e)}logExposureEvent(e,t,n,s,r){const i={experiment_variant:t,feature:e,population_id:n,identity_gid:s,stormcrow_metadata_json:r,".tag":"stormcrow_exposure_event"};this.logEvent(i)}logEvent(e,t={},n,s=!1){var r,i;if(!y(e)){const t=s?{caller:u()}:{};this.metricsReporter.recordEventStats(g(e),"pap",t)}const o=n||(null===(i=null===(r=this.persistentFields)||void 0===r?void 0:r.application)||void 0===i?void 0:i.productName)||"core_dropbox";this.logger.add(e,Object.assign(Object.assign({},t),{onFailedToSendEvent:e=>{e||this.metricsReporter.recordPermanentlyFailedEvent(),t.onFailedToSendEvent&&t.onFailedToSendEvent(e)}}),Object.assign(Object.assign({},this.persistentFields),{application:{productName:o}}))}}let V;function Q(){return V||(V=new L({transport:{type:j.apiv2,apiV2Client:new t.NoAuthApiV2Client},sendBeaconTransport:{type:j.apiv2,apiV2Client:new t.NoAuthApiV2Client(new a)}})),V}function J(){const e=Q().getPersistentFields(),n=function(){var e,n;const s=t.Viewer.get_viewer(),r=null!==(e=t.getActiveUserId())&&void 0!==e?e:c.user_id,i=null==s?void 0:s.team_id,o=null===(n=null==s?void 0:s.get_users().find((({id:e})=>e!==r)))||void 0===n?void 0:n.id;return Object.assign(Object.assign(Object.assign({},r&&{userId:r}),i&&{teamId:i}),o&&{pairedUserId:o})}(),s=[n,e.identity||{}].some((e=>Object.keys(e).length));Q().setPersistentFields(Object.assign(Object.assign({},e),!!s&&{identity:Object.assign(Object.assign({},n),e.identity)}))}function W(e,t={},n="core_dropbox",s=!1){J(),Q().logEvent(e,t,n,s)}function H(e){Q().updateConfigs(e)}var $=Object.freeze({__proto__:null,getAnalyticsClientSingleton:Q,logEvent:W,logExposureEvent:function(e,t,n,s,r){const i={experiment_variant:t,feature:e,population_id:n,identity_gid:s,stormcrow_metadata_json:r,".tag":"stormcrow_exposure_event"},o={class:"experimentation",action:"exposure",object:"stormcrow",properties:{feature:e,experimentVariant:t,populationId:n,identityGid:s,stormcrowMetadataJson:r}};try{W(o)}catch(e){W(i)}},setPersistentFields:function(e){Q().setPersistentFields(e)},updateConfigs:H});e.UUID=q,e.analytics_client_esnext=$,e.updateConfigs=H}));
//# sourceMappingURL=c_pap-client_analytics_client.js-vfluAWEl6.map
